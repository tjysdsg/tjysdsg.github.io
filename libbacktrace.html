<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>C/C++: printing stacktrace containing file name, function name, and line numbers using libbacktrace - Jiyang (Mark) Tang</title>
<meta name="description" content="I needed a library for printing stack traces when developing tan. More specifically, the compiler and the runtime had to print the function names, source file names, and the line numbers when an assertion failed or an error was raised.">


  <meta name="author" content="Jiyang (Mark) Tang">
  
  <meta property="article:author" content="Jiyang (Mark) Tang">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Jiyang (Mark) Tang">
<meta property="og:title" content="C/C++: printing stacktrace containing file name, function name, and line numbers using libbacktrace">
<meta property="og:url" content="https://tjysdsg.github.io/libbacktrace">


  <meta property="og:description" content="I needed a library for printing stack traces when developing tan. More specifically, the compiler and the runtime had to print the function names, source file names, and the line numbers when an assertion failed or an error was raised.">







  <meta property="article:published_time" content="2021-07-27T06:44:00-07:00">






<link rel="canonical" href="https://tjysdsg.github.io/libbacktrace">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Jiyang (Mark) Tang",
      "url": "https://tjysdsg.github.io/",
      "sameAs": ["https://github.com/tjysdsg","https://www.linkedin.com/in/tjy/"]
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Jiyang (Mark) Tang Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- Clicky -->
<script async src="//static.getclicky.com/101330324.js"></script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101330324ns.gif"/></p></noscript>

<!-- mathjax -->
<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            tags: 'ams'
        }
    };

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- favicon generated by https://realfavicongenerator.net -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
<link rel="manifest" href="/assets/images/site.webmanifest">
<link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/images/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/images/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WYHC5BDEPZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WYHC5BDEPZ');

</script>

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/apple-touch-icon.png" alt="Jiyang (Mark) Tang"></a>
        
        <a class="site-title" href="/">
          Jiyang (Mark) Tang
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/posts">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/">About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/me.jpg" alt="Jiyang (Mark) Tang" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Jiyang (Mark) Tang</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Software Research Scientist at Intel</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Hillsboro, OR, United States</span>
        </li>
      

      
        
          
            <li><a href="https://www.linkedin.com/in/tjy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin-in" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/tjysdsg" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      
        <li>
          <a href="mailto:jiyang.mark.tang@gmail.com">
            <meta itemprop="email" content="jiyang.mark.tang@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="C/C++: printing stacktrace containing file name, function name, and line numbers using libbacktrace">
    <meta itemprop="description" content="I needed a library for printing stack traces when developing tan.More specifically, the compiler and the runtime had to print the function names, source file names, and the linenumbers when an assertion failed or an error was raised.">
    <meta itemprop="datePublished" content="2021-07-27T06:44:00-07:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">C/C++: printing stacktrace containing file name, function name, and line numbers using libbacktrace
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-07-27T06:44:00-07:00">July 27, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>I needed a library for printing stack traces when developing <a href="https://github.com/tjysdsg/tan">tan</a>.
More specifically, the compiler and the runtime had to print the function names, source file names, and the line
numbers when an assertion failed or an error was raised.</p>

<!--more-->

<h1 id="initial-solution">Initial Solution</h1>

<p>The library was initially implemented using <a href="https://www.nongnu.org/libunwind/docs.html">libunwind</a>.
The code was based on this awesome
<a href="https://eli.thegreenplace.net/2015/programmatic-access-to-the-call-stack-in-c/">blog post</a></p>

<p>But the problem was, <strong>it couldn’t show line numbers</strong>.
The closest thing libunwind could provide was the program counter, like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>main.cpp (main+0x14)
</code></pre></div></div>

<p>To achieve the goal, we need to somehow read the debug information stored in the binary file
and use it to calculate to convert the program counter into the line numbers in the source file.</p>

<p>As <a href="https://stackoverflow.com/q/4636456/7730917">suggested</a> by some folks, I can use <code class="language-plaintext highlighter-rouge">addr2line</code> or <code class="language-plaintext highlighter-rouge">gdb</code> to
do that. However, <strong>I didn’t want to invoke an external program since they couldn’t be integrated into the
<code class="language-plaintext highlighter-rouge">tan</code> runtime</strong>.</p>

<p>Just as I was about to copy the source code of <code class="language-plaintext highlighter-rouge">addr2line</code> and wrap it into a library, I came across this <a href="https://stackoverflow.com/a/65773679/7730917">SO answer</a>.</p>

<h1 id="libbacktrace-ftw">libbacktrace FTW</h1>

<p>The SO answer said that libbacktrace could provide the functionalities I needed. After some digging, I decided to use
it and made <a href="https://github.com/tjysdsg/tan/tree/master/src/backtrace">a simple wrapper</a> around it.</p>

<p>The final API is very simple</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="nf">init_back_trace</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">print_back_trace</span><span class="p">();</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">init_back_trace</code> should be used at the beginning of the program. It is responsible for loading the debug information
of a binary (use <code class="language-plaintext highlighter-rouge">argv[0]</code> for the program itself) and it is quite an expensive routine.</p>

<p><code class="language-plaintext highlighter-rouge">print_back_trace</code> prints the stack trace starting from the current frame to the furthest frame.</p>

<p>The <a href="https://github.com/ianlancetaylor/libbacktrace/blob/master/backtrace.h">documentation</a> of the APIs is well written,
so I’m not copying and pasting them here.</p>

<p>For anyone that just wants to copy and paste my code (<strong>note that this code only works on linux and has only been
tested using gcc and clang</strong>):</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;cxxabi.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;backtrace.h&gt;</span><span class="cp">
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="nf">init_back_trace</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">);</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="kt">void</span> <span class="nf">print_back_trace</span><span class="p">();</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">__bt_state</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">bt_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">uintptr_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lineno</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">/// demangle function name</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func_name</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">demangled</span> <span class="o">=</span> <span class="n">abi</span><span class="o">::</span><span class="n">__cxa_demangle</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">func_name</span> <span class="o">=</span> <span class="n">demangled</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">/// print</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s:%d in function %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">func_name</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">bt_error_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errnum</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Error %d occurred when getting the stacktrace: %s"</span><span class="p">,</span> <span class="n">errnum</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">bt_error_callback_create</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">errnum</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Error %d occurred when initializing the stacktrace: %s"</span><span class="p">,</span> <span class="n">errnum</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">init_back_trace</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">__bt_state</span> <span class="o">=</span> <span class="n">backtrace_create_state</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bt_error_callback_create</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">print_back_trace</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__bt_state</span><span class="p">)</span> <span class="p">{</span> <span class="c1">/// make sure init_back_trace() is called</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Make sure init_back_trace() is called before calling print_stack_trace()</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">abort</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">backtrace_full</span><span class="p">((</span><span class="n">backtrace_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">__bt_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bt_callback</span><span class="p">,</span> <span class="n">bt_error_callback</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-07-27T06:44:00-07:00">July 27, 2021</time></p>


      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?text=C%2FC%2B%2B%3A+printing+stacktrace+containing+file+name%2C+function+name%2C+and+line+numbers+using+libbacktrace%20https%3A%2F%2Ftjysdsg.github.io%2Flibbacktrace" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ftjysdsg.github.io%2Flibbacktrace" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Ftjysdsg.github.io%2Flibbacktrace" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ctc" class="pagination--pager" title="Understanding the Math Behind CTC
">Previous</a>
    
    
      <a href="/ml-notes" class="pagination--pager" title="Machine Learning Notes
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ml-notes" rel="permalink">Machine Learning Notes
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2022-10-12T19:06:28-07:00">October 12, 2022</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Machine Learning review notes

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ctc" rel="permalink">Understanding the Math Behind CTC
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-06-17T19:56:00-07:00">June 17, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">In this post, I’m writing down my thought process of understanding the math behind 
Connectionist Temporal Classification (CTC) [1][2].

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/mathjax-jekyll" rel="permalink">Adding mathjax to jekyll
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2021-05-29T00:31:00-07:00">May 29, 2021</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          less than 1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Steps

1. Check for _includes/head.html file in your project

If you don’t have _includes/head.html in your jekyll project, create one.

Be careful that it w...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Jiyang (Mark) Tang. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>










  </body>
</html>
